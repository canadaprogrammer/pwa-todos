<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Todo List</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@300;400;700&display=swap" rel="stylesheet">
  <script src="https://kit.fontawesome.com/581353a056.js" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="/css/default.css" type="text/css">
  <link rel="stylesheet" href="/css/nav.css" type="text/css">
  <link rel="stylesheet" href="/css/home.css" type="text/css">
  <!-- ios support -->
  <link rel="apple-touch-icon" sizes="192x192" href="/img/icons/ios/256.png">
  <meta name="applie-mobile-web-app-status-bar" content="#aa33ff">
  <!-- favicon -->
  <link rel="icon" type="image/png" sizes="32x32" href="/img/favicon/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/img/favicon/favicon-16x16.png">
  <link rel="mask-icon" href="/img/favicon/safari-pinned-tab.svg" color="#5bbad5">
  <meta name="msapplication-TileColor" content="#da532c">
  <meta name="theme-color" content="#ffffff">
  <!-- end favicon -->
  <link rel="manifest" href="/manifest.json">
</head>
<body>
  <!-- tob nav -->
  <nav>
    <div class="nav-wrapper container">
      <div class="title"><i class="fas fa-tasks"></i> Todo List</div>
      <div class="sidebar-trigger" data-target="side-menu">
        <div class="btn-line"></div>
        <div class="btn-line"></div>
        <div class="btn-line"></div>
      </div>
    </div>
  </nav>
  <!-- side nav -->
  <ul id="side-menu" class="sidebar">
    <li class="menus"><a href="/index.html">Todo List</a></li>
    <li class="menus"><a href="/pages/not_todo.html">Not Todo List</a></li>
    <li><div class="divider"></div></li>
    <li class="menus"><a href="/pages/calendar.html">Calendar</a></li>
  </ul>
  <!-- add form -->
  <div id="add-form">
    <form>
      <div class="title">New Todo</div>
      <div class="divider"></div>
      <div class="input-field">
        <label for="title">Title</label>
        <input id="title" name="title" type="text">
      </div>
      <div class="input-field">
        <label for="description">Description</label>
        <input id="description" name="description" type="text">
      </div>
      <div class="input-field">
        <label for="date">Date</label>
        <input id="date" name="date" type="date">
      </div>
      <div class="input-field">
        <label for="start_time">Start Time</label>
        <input id="start_time" name="start_time" type="time">
      </div>
      <div class="input-field">
        <label for="end_time">End Time</label>
        <input id="end_time" name="end_time" type="time">
      </div>
      <div class="text-center">
        <button type="submit">Add</button>
      </div>      
    </form>
  </div>
  <!-- list -->
  <div class="list-wrapper container">
  </div>
  <div id="todo-add">
    <i class="fas fa-plus-square"></i>
  </div>
  <!-- overlay -->
  <div id="overlay"></div>

  <script type="module">
    // Import the functions you need from the SDKs you need
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.1.3/firebase-app.js";
    import { getFirestore, query, collection, onSnapshot, enableIndexedDbPersistence, addDoc, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/9.1.3/firebase-firestore.js";
    // TODO: Add SDKs for Firebase products that you want to use
    // https://firebase.google.com/docs/web/setup#available-libraries
  
    // Your web app's Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyC1z7CrEsCWEC6L7ICxVxuB6FZFb7FuiRE",
      authDomain: "pwa---todo.firebaseapp.com",
      projectId: "pwa---todo",
      storageBucket: "pwa---todo.appspot.com",
      messagingSenderId: "974337589423",
      appId: "1:974337589423:web:bb81d319cde836f976d45a"
    };
  
    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // offline date
    enableIndexedDbPersistence(db)
      .catch(err => {
        if(err.code == 'failed-precondition'){
          // probably multiple tabs open at once
          console.log('persistence failed');
        } else if(err.code == 'unimplemented'){
          // lack of browser support
          console.log('persistence is not available');
        }
      });

    // real-time listener
    const q = query(collection(db, 'todos'));
    const unsubscribe = onSnapshot(q, snapshot => {
      // check changes of data
      // console.log(snapshot.docChanges());
      snapshot.docChanges().forEach(change => {
        // console.log(change, change.doc.data(), change.doc.id);
        if(change.type === 'added'){
          // add the document data to the web page
          renderTodo(change.doc.data(), change.doc.id);
        }
        if(change.type === 'removed'){
          // remove the document data from the web page
          removeTodo(change.doc.id);
        }
      })
    });

    // add new todo
    const form = document.querySelector('form');
    form.addEventListener('submit', evt => {
      evt.preventDefault();
      const date = form.date.value;
      const start_time = form.start_time.value;
      const end_time = form.end_time.value;
      const temp_start_datetime = new Date(`${date} ${start_time}`);
      const temp_end_datetime = new Date(`${date} ${end_time}`);
      // change timezone
      // const change_server_timezone = datetime => {
      //   const dt = datetime.toLocaleString('en-US', {
      //     timeZone: "America/Los_Angeles",
      //     hour12: false
      //   });
      //   const dt_arr = dt.split(', ');
      //   let date = dt_arr[0].split('/');
      //   date = `${date[2]}-${date[0]}-${date[1]}`;
      //   return `${date} ${dt_arr[1]}`;
      // }
      // const start_datetime = new Date(change_server_timezone(temp_start_datetime));
      // const end_datetime = new Date(change_server_timezone(temp_end_datetime));
      // save timestamp
      const todo = {
        title: form.title.value,
        content: form.description.value,
        start_time: temp_start_datetime,
        end_time: temp_end_datetime
      }
      addDoc(collection(db, 'todos'), todo)
        .then(form_init())
        .catch(err => console.log(err));
    });

    // remove todo
    const todoContainer = document.querySelector('.list-wrapper');
    todoContainer.addEventListener('click', evt => {
      if(evt.target.tagName === 'I' || evt.target.className === 'todo-remove'){
        const id = evt.target.getAttribute('data-id');
        let isExecuted = confirm('Are your sure to delete?');
        if(isExecuted){
          deleteDoc(doc(db, 'todos', id));
        }
      }
    })
  </script>

  
  <script src="/js/app.js"></script>
  <script src="/js/nav.js"></script>
  <script src="/js/default.js"></script>
</body>
</html>